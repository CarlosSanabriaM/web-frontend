<h2>{{sectionName}}</h2>

<div class="row">
  <!-- Textarea at the left in medium screen size or above, and up in small and extra small screen size  -->
  <div class="col-md">
    <form>
      <mat-form-field appearance="outline" id="text-textarea-form-field">
        <textarea #textarea (dragover)="allowDrop($event)" (drop)="drop($event)" [formControl]="textAreaFormControl"
                  id="textarea" matInput placeholder="Introduce un texto" rows="{{textAreaNumRows}}"></textarea>
        <mat-error *ngIf="textAreaFormControl.invalid">{{getTextareaErrorMessage()}}</mat-error>
      </mat-form-field>
    </form>
  </div>
  <!-- Options at the right in medium screen size or above, and down in small and extra small screen size  -->
  <div class="col-md" id="text-options">
    <mat-accordion>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Topics relacionados</mat-panel-title>
        </mat-expansion-panel-header>
        <!-- Related topics options -->
        <div class="text-option" id="related-topics-options">
          <!-- Slider with min and max values at it sides -->
          <span class="text-small text-secondary slider-min-value">{{maxNumTopicsMinValue}}</span>
          <mat-slider #sliderMaxNumTopics [max]="maxNumTopicsMaxValue" [min]="maxNumTopicsMinValue"
                      [value]="maxNumTopics" color="primary" thumbLabel></mat-slider>
          <span class="text-small text-secondary slider-max-value">{{maxNumTopicsMaxValue}}</span>
          <p class="slider-footer">Número máx. de topics devueltos</p>

          <!-- TODO: Add checkbox "Show visualization" and implement that behaviour -->

          <button (click)="getRelatedTopics(textarea.value, sliderMaxNumTopics.value)" [disabled]="relatedTopicsLoading"
                  color="primary" mat-raised-button>
            Obtener
          </button>
        </div>
      </mat-expansion-panel>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Documentos similares</mat-panel-title>
        </mat-expansion-panel-header>
        <!-- Related documents options -->
        <div class="text-option" id="related-documents-options">
          <!-- Slider with min and max values at it sides -->
          <span class="text-small text-secondary slider-min-value">{{numDocumentsMinValue}}</span>
          <mat-slider #sliderNumDocuments [max]="numDocumentsMaxValue" [min]="numDocumentsMinValue"
                      [value]="numDocuments" color="primary" thumbLabel></mat-slider>
          <span class="text-small text-secondary slider-max-value">{{numDocumentsMaxValue}}</span>
          <p class="slider-footer">Número de documentos devueltos</p>

          <button (click)="getRelatedDocuments(textarea.value, sliderNumDocuments.value)"
                  [disabled]="relatedDocumentsLoading" color="primary"
                  mat-raised-button>
            Obtener
          </button>
        </div>
      </mat-expansion-panel>
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Resumir texto</mat-panel-title>
        </mat-expansion-panel-header>
        <!-- Text summary options -->
        <div class="text-option" id="text-summary-options">
          <!-- TODO: Content here -->
          <div>
            <mat-form-field appearance="fill">
              <mat-label>Número de frases</mat-label>
              <input #inputNumSummarySentences [formControl]="numSummarySentencesFormControl"
                     matInput min="1" step="1" type="number">
              <mat-error
                *ngIf="numSummarySentencesFormControl.invalid">{{getNumSummarySentencesErrorMessage()}}</mat-error>
              <mat-icon matSuffix>notes</mat-icon>
            </mat-form-field>
          </div>

          <!-- TODO: Disable the button while the text summary is loading.
                This way, the user can't ask for another summary while other is being generated. -->
          <!-- Only get the text summary if the numSummarySentences value is valid and the text is not empty -->
          <button (click)="numSummarySentencesFormControl.valid
                           && getTextSummary(textarea.value, +inputNumSummarySentences.value)"
                  [disabled]="textSummaryLoading"
                  color="primary" mat-raised-button>
            Obtener
          </button>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>
</div>


<!-- If the related topics are loading or have been loaded, show a card -->
<div *ngIf="relatedTopicsLoading || relatedTopics" class="card">

  <h3 class="card-header">
    Probabilidad texto-topics
    <!-- Button to close the card -->
    <button (click)="closeRelatedTopicsCard()" aria-label="Close" class="close">
      <span aria-hidden="true">&times;</span>
    </button>
  </h3>

  <div class="card-body">
    <!-- If the related topics are loading, show a progress spinner and scroll the page to it -->
    <div *ngIf="relatedTopicsLoading; else relatedTopicsLoaded" appScroll>
      <mat-spinner color="primary"></mat-spinner>
    </div>

    <!-- If the related topics have been loaded, show them -->
    <ng-template #relatedTopicsLoaded>
      <div class="row justify-content-center">
        <!--
          * In medium, large and extra large screens, the table and the histogram are in the same row, with the table being smaller.
          * In extra small and small screens, the table and the histogram are in different rows, with the table being smaller.
        -->
        <div class="col-md-4 col-8">
          <table class="table table-striped table-hover table-sm">
            <thead class="thead-light">
            <tr>
              <th scope="col">Núm. topic</th>
              <th scope="col">Probabilidad</th>
            </tr>
            </thead>

            <tr *ngFor="let textTopicProb of relatedTopics">
              <th scope="row">{{textTopicProb.topic}}</th>
              <td>{{textTopicProb.text_topic_prob | percent:'1.6'}}</td>
            </tr>
          </table>
        </div>

        <div class="col-md-8 col-12">
          <app-histogram [data]="relatedTopicsHistogramData"></app-histogram>
        </div>
      </div>
    </ng-template>
  </div>

</div>


<!-- If the related documents are loading or have been loaded, show a card -->
<div *ngIf="relatedDocumentsLoading || relatedDocuments" class="card">

  <h3 class="card-header">
    Documentos más similares al texto
    <!-- Button to close the card -->
    <button (click)="closeRelatedDocumentsCard()" aria-label="Close" class="close">
      <span aria-hidden="true">&times;</span>
    </button>
  </h3>

  <div class="card-body">
    <!-- If the related documents are loading, show a progress spinner and scroll the page to it -->
    <div *ngIf="relatedDocumentsLoading; else relatedDocumentsLoaded" appScroll>
      <mat-spinner color="primary"></mat-spinner>
    </div>

    <!-- If the related documents have been loaded, show them -->
    <ng-template #relatedDocumentsLoaded>
      <!-- With multi, more than one panel can be opened at the same time -->
      <mat-accordion multi>
        <mat-expansion-panel *ngFor="let relatedDoc of relatedDocuments">
          <mat-expansion-panel-header>
            <mat-panel-title>
              {{relatedDoc.doc_content_summary | slice:0:relatedDocumentSummaryMaxLength}}
              {{relatedDoc.doc_content_summary.length > relatedDocumentSummaryMaxLength ? '...' : ''}}
            </mat-panel-title>
            <mat-panel-description>
              Topic: {{relatedDoc.doc_topic}}
              &nbsp;&nbsp;&nbsp;
              Probabilidad: {{relatedDoc.doc_text_prob | percent:'1.2'}}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <pre>
            {{relatedDoc.doc_content}}
          </pre>
        </mat-expansion-panel>
      </mat-accordion>
    </ng-template>
  </div>

</div>

<!-- If the text summary is loading or has been loaded, show a card -->
<div *ngIf="textSummaryLoading || textSummary">
  <ngb-alert (close)="summaryAlertClosed=true" *ngIf="!summaryAlertClosed" type="warning">
    El algoritmo PageRank utilizado para generar el resumen no ha convergido con el texto dado,
    por lo que no se ha podido generar el resumen utilizando dicho algoritmo.<br>
    En su lugar, el resumen devuelto está compuesto por las {{summaryAlertNumSentences}} primeras frases del texto.
  </ngb-alert>

  <div class="card">

    <h3 class="card-header">
      Texto resumido
      <!-- Button to close the card -->
      <button (click)="closeTextSummaryCard()" aria-label="Close" class="close">
        <span aria-hidden="true">&times;</span>
      </button>
    </h3>

    <div class="card-body">
      <!-- If the text summary is loading, show a progress spinner and scroll the page to it -->
      <div *ngIf="textSummaryLoading; else textSummaryLoaded" appScroll>
        <mat-spinner color="primary"></mat-spinner>
      </div>

      <!-- If the text summary has been loaded, show them -->
      <ng-template #textSummaryLoaded>
        <pre class="card-text">{{textSummary.text_summary}}</pre>
      </ng-template>
    </div>

  </div>
</div>
